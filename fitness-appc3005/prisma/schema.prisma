
generator client {
  provider        = "prisma-client"
  output          = "../generated/prisma"
  previewFeatures = ["views"]

}

datasource db {
  provider = "postgresql"
}

model Member {
  id           Int            @id @default(autoincrement())
  userId       String         @unique // Link to Better Auth User
  firstName    String
  lastName     String
  email        String         @unique
  registeredAt DateTime       @default(now())
  bookings     Booking[]
  metrics      HealthMetric[]

  //1. PK: id (Int) - Unique identifier for the member (and user)
  //2. FK: userId (String) - Link to Better Auth User
  //3. onDelete: Cascade - If user is deleted, delete the member
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  //Makes lookup by userId faster
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           String       @default("member")
  createdAt      DateTime

  @@index([userId])
  @@index([organizationId])
  @@map("member")
}

model Trainer {
  id       Int            @id @default(autoincrement())
  name     String
  email    String         @unique
  sessions ClassSession[]
}

model Room {
  id       Int            @id @default(autoincrement())
  name     String         @unique
  capacity Int
  sessions ClassSession[]
}

// Fitness app's class/workout sessions

model ClassSession {
  id        Int       @id @default(autoincrement())
  trainerId Int
  roomId    Int
  name      String
  dateTime  DateTime
  capacity  Int
  bookings  Booking[]
  room      Room      @relation(fields: [roomId], references: [id])
  trainer   Trainer   @relation(fields: [trainerId], references: [id])

  //Good for finding sessions for a trainer on a specific date
  //Sorting sessions by date
  //Finding sessions by trainer

  @@index([trainerId, dateTime])
  @@map("class_session")
}

// Better Auth authentication sessions

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  activeOrganizationId String?

  @@index([userId])
  @@map("session")
}

model Booking {
  id             Int          @id @default(autoincrement())
  memberId       Int
  classSessionId Int
  createdAt      DateTime     @default(now())
  member         Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  classSession   ClassSession @relation(fields: [classSessionId], references: [id])

  //prevents duplicate bookings
  //Good for finding all members of a session
  //Or counting the number of bookings for a session
  @@unique([memberId, classSessionId])
  @@index([classSessionId])
}

model HealthMetric {
  id         Int      @id @default(autoincrement())
  memberId   Int
  timestamp  DateTime @default(now())
  weight     Int
  weightGoal Int

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, timestamp])
}

view MemberInfo {
  weight     Int
  weightGoal Int
  firstName  String
  lastName   String
  email      String
}

model User {
  id            String    @id //This would be a UUID 
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[] // Better Auth sessions
  accounts      Account[]
  member        Member? // Optional relation to fitness app Member
  invitations Invitation[]

  @@unique([email])
  @@map("user")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Organization {
  id          String       @id
  name        String
  slug        String
  logo        String?
  createdAt   DateTime
  metadata    String?
  members     Member[]
  invitations Invitation[]

  @@unique([slug])
  @@map("organization")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@map("invitation")
}
